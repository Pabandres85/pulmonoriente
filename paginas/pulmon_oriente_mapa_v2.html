<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa ¬∑ Pulm√≥n del Oriente ¬∑ Cali</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --verde-bosque: #1B4D2E;
      --verde-medio: #2E7D52;
      --verde-claro: #4CAF77;
      --verde-pale: #E8F5EE;
      --dorado: #C9A227;
      --rosa-area: #E91E8C;
      --cyan-tramo: #00BCD4;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; font-family:'IBM Plex Sans', sans-serif; background:#EEF0EB; }

    #header {
      position:fixed; top:0; left:0; right:0; z-index:1200;
      background:var(--verde-bosque); color:white;
      padding:10px 20px; display:flex; align-items:center;
      justify-content:space-between; gap:16px;
      box-shadow:0 2px 12px rgba(0,0,0,0.4); height:58px;
    }
    .header-left { display:flex; align-items:center; gap:12px; }
    .header-icon { width:36px; height:36px; background:var(--verde-claro); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
    .header-title { font-family:'Playfair Display',serif; font-size:17px; font-weight:700; line-height:1.2; }
    .header-sub { font-size:11px; opacity:0.72; letter-spacing:0.08em; text-transform:uppercase; margin-top:2px; }
    .kpis { display:flex; gap:20px; align-items:center; }
    .kpi { text-align:center; line-height:1.2; }
    .kpi-num { font-family:'Playfair Display',serif; font-size:18px; font-weight:700; color:var(--verde-claro); }
    .kpi-lab { font-size:10px; opacity:0.75; text-transform:uppercase; letter-spacing:0.07em; }
    .kpi-div { width:1px; height:30px; background:rgba(255,255,255,0.2); }

    #filter-bar {
      position:fixed; top:58px; left:0; right:0; z-index:1100;
      background:rgba(27,77,46,0.97); backdrop-filter:blur(8px);
      padding:8px 16px; display:flex; align-items:center;
      gap:10px; flex-wrap:wrap; box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    .filter-label { font-size:11px; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:0.08em; white-space:nowrap; }
    .filter-group { display:flex; gap:6px; flex-wrap:wrap; }
    .filter-btn {
      padding:4px 10px; border-radius:20px; border:1.5px solid rgba(255,255,255,0.3);
      background:transparent; color:rgba(255,255,255,0.85);
      font-size:12px; font-family:'IBM Plex Sans',sans-serif; cursor:pointer; transition:all 0.2s; white-space:nowrap;
    }
    .filter-btn:hover { border-color:var(--verde-claro); color:white; }
    .filter-btn.active { background:var(--verde-claro); border-color:var(--verde-claro); color:var(--verde-bosque); font-weight:600; }
    .filter-sep { width:1px; height:24px; background:rgba(255,255,255,0.15); }
    #btn-reset {
      margin-left:auto; padding:4px 12px; border-radius:20px;
      border:1.5px solid var(--dorado); background:transparent; color:var(--dorado);
      font-size:12px; font-family:'IBM Plex Sans',sans-serif; cursor:pointer; transition:all 0.2s;
    }
    #btn-reset:hover { background:var(--dorado); color:#1A1A1A; }

    #map { position:fixed; top:104px; left:0; right:0; bottom:0; }

    @media(max-width:480px) {
      #filter-bar { min-height:40px; }
      #map { top:130px; } /* header(48px) + filter(~82px) when wrapped */
    }
    @media(max-width:360px) {
      #map { top:120px; }
    }

    /* Legend */
    #legend {
      position:absolute; bottom:80px; left:16px; z-index:900;
      background:rgba(27,77,46,0.95); color:white; padding:14px 16px;
      border-radius:10px; min-width:190px;
      border:1px solid rgba(76,175,119,0.4);
      backdrop-filter:blur(8px);
      box-shadow:0 4px 16px rgba(0,0,0,0.3);
    }
    .legend-title { font-size:11px; text-transform:uppercase; letter-spacing:0.1em; opacity:0.7; margin-bottom:10px; }
    .legend-item { display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:12px; }
    .legend-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
    .legend-line { width:18px; height:3px; flex-shrink:0; border-radius:2px; }
    .legend-poly { width:18px; height:12px; border-radius:2px; flex-shrink:0; }
    .legend-sep { height:1px; background:rgba(255,255,255,0.1); margin:8px 0; }

    /* Area badge */
    #area-badge {
      position:absolute; top:16px; right:16px; z-index:900;
      background:rgba(233,30,140,0.15); color:white;
      border:2px solid rgba(233,30,140,0.7);
      padding:8px 14px; border-radius:8px; font-size:12px;
      backdrop-filter:blur(8px); text-align:center;
    }
    .area-badge-title { font-size:10px; opacity:0.8; text-transform:uppercase; letter-spacing:0.08em; }
    .area-badge-val { font-family:'Playfair Display',serif; font-size:16px; font-weight:700; color:#FF80C8; margin-top:2px; }

    /* Popup */
    .leaflet-popup-content-wrapper {
      background:rgba(13,27,18,0.96) !important;
      color:white !important;
      border-radius:10px !important;
      border:1px solid rgba(76,175,119,0.35) !important;
      backdrop-filter:blur(12px) !important;
      box-shadow:0 8px 32px rgba(0,0,0,0.4) !important;
    }
    .leaflet-popup-tip { background:rgba(13,27,18,0.96) !important; }

    /* Layer switcher */
    #layer-ctrl {
      position:absolute; top:16px; right:16px; z-index:900;
      display:flex; flex-direction:column; gap:4px;
    }
    .layer-btn {
      padding:6px 14px; border-radius:20px; border:none; cursor:pointer;
      font-family:'IBM Plex Sans',sans-serif; font-size:12px; font-weight:600;
      background:rgba(255,255,255,0.92); color:#333;
      box-shadow:0 2px 8px rgba(0,0,0,0.25); transition:all 0.18s;
      backdrop-filter:blur(6px);
    }
    .layer-btn:hover { background:white; box-shadow:0 3px 12px rgba(0,0,0,0.35); }
    .layer-btn.active { background:var(--verde-bosque); color:white; }
    .layer-btn-group {
      background:rgba(255,255,255,0.92);
      border-radius:24px; padding:4px;
      display:flex; gap:4px;
      box-shadow:0 2px 12px rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
    }
    .layer-btn-group .layer-btn {
      box-shadow:none; border-radius:18px; padding:5px 12px;
      background:transparent;
    }
    .layer-btn-group .layer-btn.active { background:var(--verde-bosque); color:white; }
    .popup-title { font-family:'Playfair Display',serif; font-size:14px; font-weight:700; margin-bottom:8px; color:white; }
    .popup-row { display:flex; justify-content:space-between; gap:12px; margin-bottom:4px; font-size:12px; }
    .popup-label { opacity:0.65; white-space:nowrap; }
    .popup-val { font-weight:600; text-align:right; }
    .popup-badge {
      display:inline-block; padding:2px 8px; border-radius:12px;
      font-size:11px; font-weight:600; margin-top:6px;
    }
    .badge-ejecucion { background:#2E7D52; color:white; }
    .badge-alistamiento { background:#C9A227; color:#1A1A1A; }
    .badge-terminado { background:#1565C0; color:white; }
    .progress-bar {
      background:rgba(255,255,255,0.15); border-radius:4px;
      height:6px; width:100%; margin-top:8px;
    }
    .progress-fill { height:100%; border-radius:4px; background:var(--verde-claro); transition:width 0.5s; }

    /* Switcher nav */
    .page-switcher {
      position:fixed; bottom:24px; left:50%; transform:translateX(-50%); z-index:2000;
      background:rgba(27,77,46,0.96); border-radius:40px;
      padding:8px 16px; display:flex; gap:6px; align-items:center;
      box-shadow:0 4px 20px rgba(0,0,0,0.4); backdrop-filter:blur(12px);
      border:1px solid rgba(76,175,119,0.25);
    }
    .switcher-btn {
      padding:7px 18px; border-radius:30px; border:none; cursor:pointer;
      font-family:'IBM Plex Sans',sans-serif; font-size:13px; font-weight:600;
      background:transparent; color:rgba(255,255,255,0.7); transition:all 0.2s;
    }
    .switcher-btn:hover { color:white; background:rgba(76,175,119,0.2); }
    .switcher-btn.active { background:var(--verde-claro); color:var(--verde-bosque); }
    @media(max-width:768px) {
      .kpi-num { font-size:14px; }
      .kpi-lab { font-size:9px; }
      .kpis { gap:12px; }
      .kpi-div { display:none; }
      .header-title { font-size:14px; }
      .header-sub { display:none; }
      #filter-bar { gap:6px; padding:6px 10px; }
      .filter-label { font-size:10px; }
      .filter-btn { font-size:11px; padding:3px 8px; }
      .layer-btn-group { bottom:80px; }
    }
    @media(max-width:480px) {
      .kpis { display:none; }
      .switcher-btn { padding:5px 12px; font-size:12px; }
      #filter-bar { padding:5px 8px; gap:5px; flex-wrap:wrap; }
      .filter-sep { display:none; }
      .filter-group { gap:4px; }
      .filter-btn { font-size:10px; padding:3px 7px; }
      #btn-reset { font-size:10px; padding:3px 9px; }
      #legend { min-width:160px; padding:10px 12px; font-size:11px; bottom:70px; }
      .legend-title { font-size:10px; }
      #layer-ctrl { top:10px; right:8px; }
      .layer-btn-group .layer-btn { font-size:11px; padding:4px 9px; }
    }
    @media(max-width:360px) {
      .filter-label { display:none; }
      .filter-btn { font-size:9px; padding:3px 6px; }
    }
  </style>
</head>
<body>

<div id="header">
  <div class="header-left">
    <div class="header-icon">üåø</div>
    <div>
      <div class="header-title">Pulm√≥n del Oriente</div>
      <div class="header-sub">√Årea de influencia ¬∑ Cali 2024‚Äì2027</div>
    </div>
  </div>
  <div class="kpis">
    <div class="kpi"><div class="kpi-num">208</div><div class="kpi-lab">Proyectos</div></div>
    <div class="kpi-div"></div>
    <div class="kpi"><div class="kpi-num">$52,975M</div><div class="kpi-lab">Inversi√≥n</div></div>
    <div class="kpi-div"></div>
    <div class="kpi"><div class="kpi-num">6.6%</div><div class="kpi-lab">Avance</div></div>
  </div>
</div>

<div id="filter-bar">
  <span class="filter-label">Secretar√≠a:</span>
  <div class="filter-group" id="filter-sec">
    <button class="filter-btn active" data-filter="all">Todas</button>
    <button class="filter-btn" data-filter="Vivienda" style="border-color:#E67E22;">Vivienda</button>
    <button class="filter-btn" data-filter="Educaci√≥n" style="border-color:#3498DB;">Educaci√≥n</button>
    <button class="filter-btn" data-filter="Salud" style="border-color:#E74C3C;">Salud</button>
    <button class="filter-btn" data-filter="Deporte" style="border-color:#9B59B6;">Deporte</button>
    <button class="filter-btn" data-filter="Cultura" style="border-color:#F1C40F;">Cultura</button>
    <button class="filter-btn" data-filter="Otras" style="border-color:#1ABC9C;">Otras</button>
  </div>
  <div class="filter-sep"></div>
  <span class="filter-label">Estado:</span>
  <div class="filter-group" id="filter-estado">
    <button class="filter-btn active" data-estado="all">Todos</button>
    <button class="filter-btn" data-estado="En ejecuci√≥n">En ejecuci√≥n</button>
    <button class="filter-btn" data-estado="En alistamiento">Alistamiento</button>
    <button class="filter-btn" data-estado="Terminado">Terminado</button>
  </div>

  <div class="filter-group" id="filter-modo">
      <span class="filter-label">Modo de Vista:</span>
      <button class="filter-btn active" data-modo="ups">Frentes de Obra (UPS)</button>
      <button class="filter-btn" data-modo="contratos">Todos los Contratos</button>
    </div>
  <button id="btn-reset">‚Ü∫ Limpiar</button>
</div>

<div id="map"></div>

<div id="layer-ctrl">
  <div class="layer-btn-group">
    <button class="layer-btn active" onclick="setLayer('streets')" id="btn-streets">üó∫ Calles</button>
    <button class="layer-btn" onclick="setLayer('satellite')" id="btn-satellite">üõ∞ Sat√©lite</button>
    <button class="layer-btn" onclick="setLayer('hybrid')" id="btn-hybrid">‚äï H√≠brido</button>
  </div>
</div>

<div id="legend">
  <div class="legend-title">Referencias</div>
  <div class="legend-item"><div class="legend-poly" style="background:rgba(233,30,140,0.15);border:2px solid #E91E8C;"></div> Per√≠metro del √°rea</div>
  <div class="legend-item"><div class="legend-line" style="background:#00BCD4;"></div> Corredor h√≠drico</div>
  <div class="legend-sep"></div>
  <div class="legend-item"><div class="legend-dot" style="background:#E67E22;"></div> Vivienda</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3498DB;"></div> Educaci√≥n</div>
  <div class="legend-item"><div class="legend-dot" style="background:#E74C3C;"></div> Salud</div>
  <div class="legend-item"><div class="legend-dot" style="background:#9B59B6;"></div> Deporte</div>
  <div class="legend-item"><div class="legend-dot" style="background:#F1C40F;"></div> Cultura</div>
  <div class="legend-item"><div class="legend-dot" style="background:#1ABC9C;"></div> Otras</div>
</div>

<!-- ‚îÄ‚îÄ NAV SWITCHER ‚îÄ‚îÄ -->
<nav class="page-switcher" aria-label="Navegaci√≥n entre vistas">
  <a class="switcher-home" href="../index.html" title="Inicio">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
  </a>
  <div class="switcher-divider"></div>
  <a class="switcher-btn" href="pulmon_oriente_informe-v2.html">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2.5 2.1H4.5V5h15v14.1zm0-16.1h-15C3.6 3 3 3.6 3 4.5v15C3 20.4 3.6 21 4.5 21h15c.9 0 1.5-.6 1.5-1.5v-15C21 3.6 20.4 3 19.5 3z"/></svg>
    Informe
  </a>
  <a class="switcher-btn active" href="pulmon_oriente_mapa_v2.html" aria-current="page">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
    Mapa
  </a>
</nav>
<style>
.page-switcher { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; align-items: center; gap: 0; background: rgba(27, 77, 46, 0.96); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 40px; padding: 6px 10px; box-shadow: 0 6px 28px rgba(0,0,0,0.28), 0 1px 4px rgba(0,0,0,0.15); border: 1px solid rgba(76, 175, 119, 0.25); }
.switcher-home { display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 50%; color: rgba(255,255,255,0.65); text-decoration: none; transition: all 0.2s; flex-shrink: 0; }
.switcher-home:hover { color: #fff; background: rgba(255,255,255,0.12); }
.switcher-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.18); margin: 0 6px; flex-shrink: 0; }
.switcher-btn { display: flex; align-items: center; gap: 5px; padding: 6px 14px; border-radius: 30px; font-family: 'IBM Plex Sans', sans-serif; font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.72); text-decoration: none; letter-spacing: 0.03em; transition: all 0.2s; white-space: nowrap; }
.switcher-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
.switcher-btn.active { background: #4CAF77; color: #1B4D2E; font-weight: 600; }
.switcher-btn.active:hover { background: #5DC88A; }
@media (max-width: 480px) { .page-switcher { bottom: 14px; padding: 5px 8px; } .switcher-btn { padding: 5px 10px; font-size: 11px; } }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>

const SEC_COLORS = { "Vivienda": "#E67E22", "Educaci√≥n": "#3498DB", "Salud": "#E74C3C", "Deporte": "#9B59B6", "Cultura": "#F1C40F", "Otras": "#1ABC9C" };
function secGroup(s) {
  if (!s) return "Otras";
  if (s.includes("Vivienda") || s.includes("H√°bitat")) return "Vivienda";
  if (s.includes("Educaci√≥n") || s.includes("Educacion")) return "Educaci√≥n";
  if (s.includes("Salud")) return "Salud";
  if (s.includes("Deporte") || s.includes("Recreaci√≥n")) return "Deporte";
  if (s.includes("Cultura")) return "Cultura";
  return "Otras";
}
function getColor(s) { return SEC_COLORS[secGroup(s)]; }

const map = L.map('map', {zoomControl:true, attributionControl:false}).setView([3.430, -76.488], 14);

const baseLayers = {
  streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, subdomains:'abc'}),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19}),
  hybrid: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19})
};
const labelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {maxZoom:19, subdomains:'abcd', pane:'shadowPane'});
baseLayers.streets.addTo(map);

const baseMaps = { "üó∫Ô∏è Calles": baseLayers.streets, "üõ∞Ô∏è Sat√©lite Puro": baseLayers.satellite, "üåê Sat√©lite + Calles": L.layerGroup([baseLayers.hybrid, labelsLayer]) };

const clusters = L.markerClusterGroup({
  maxClusterRadius: 45, showCoverageOnHover: false,
  iconCreateFunction: (c) => {
    const n = c.getChildCount();
    const sz = n < 10 ? 36 : n < 50 ? 44 : 52;
    return L.divIcon({ html: `<div style="width:${sz}px;height:${sz}px;border-radius:50%; background:rgba(27,77,46,0.95);border:3px solid #4CAF77; display:flex;align-items:center;justify-content:center; font-size:13px;font-weight:700;color:white; box-shadow:0 3px 10px rgba(0,0,0,0.4);">${n}</div>`, className:'', iconSize:[sz,sz] });
  }
});

let globalPtsData = null;
let globalPerimetro = null;
let allMarkers = [];
let activeFilter = 'all';
let activeEstado = 'all';
let currentMode = 'ups'; // 'ups' o 'contratos'

function applyFilters() {
  clusters.clearLayers();
  allMarkers.forEach(m => {
    const secOk = activeFilter === 'all' || m._secGroup === activeFilter;
    const estOk = activeEstado === 'all' || m._estado === activeEstado;
    if (secOk && estOk) clusters.addLayer(m);
  });
}

function renderMapData() {
  clusters.clearLayers();
  allMarkers = [];
  let proyectos = [];
  let totalInversion = 0;

  if (currentMode === 'contratos') {
    // MODO CONTRATOS (190 filas)
    globalPtsData.features.forEach(f => {
      if (!f.geometry || !turf.booleanPointInPolygon(f, globalPerimetro)) return;
      const props = f.properties;
      let pptoStr = (props.presupuest || '0').toString().replace(/[^0-9\.,]/g, '');
      if (pptoStr.endsWith('.00') || pptoStr.endsWith(',00')) pptoStr = pptoStr.slice(0, -3);
      const ppto = parseFloat(pptoStr.replace(/[\.,]/g, '')) || 0;
      
      proyectos.push({
        nombre: props.nombre_up || 'Sin Nombre', secretaria: secGroup(props.nombre_cen), 
        estado: props.estado || 'Alistamiento', tipo: props.tipo_equip || 'Otro', direccion: props.direccion || 'No registrada',
        avance: parseFloat(props.avance_obr) || 0, presupuesto: ppto, lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0]
      });
      totalInversion += ppto;
    });
  } else {
    // MODO UPS / FRENTES (Deduplicado por dir+lat+lon+tipo, tomando el MAX presupuesto)
    const upsMap = new Map();
    globalPtsData.features.forEach(f => {
      if (!f.geometry || !turf.booleanPointInPolygon(f, globalPerimetro)) return;
      const props = f.properties;
      let pptoStr = (props.presupuest || '0').toString().replace(/[^0-9\.,]/g, '');
      if (pptoStr.endsWith('.00') || pptoStr.endsWith(',00')) pptoStr = pptoStr.slice(0, -3);
      const ppto = parseFloat(pptoStr.replace(/[\.,]/g, '')) || 0;
      
      const lat = f.geometry.coordinates[1];
      const lon = f.geometry.coordinates[0];
      const uniqueKey = `${props.direccion}_${lat}_${lon}_${props.tipo_equip}`;

      if (!upsMap.has(uniqueKey)) {
        upsMap.set(uniqueKey, {
          nombre: props.nombre_up || 'Sin Nombre', secretaria: secGroup(props.nombre_cen),
          estado: props.estado || 'Alistamiento', tipo: props.tipo_equip || 'Otro', direccion: props.direccion || 'No registrada',
          avance: parseFloat(props.avance_obr) || 0, presupuesto: ppto, lat: lat, lon: lon
        });
      } else {
        const ups = upsMap.get(uniqueKey);
        ups.presupuesto = Math.max(ups.presupuesto, ppto); // Usa el presupuesto m√°ximo para no duplicar
        ups.avance = Math.max(ups.avance, parseFloat(props.avance_obr) || 0);
      }
    });
    proyectos = Array.from(upsMap.values());
    totalInversion = proyectos.reduce((sum, p) => sum + p.presupuesto, 0);
  }

  // Actualizar KPIs Header
  document.querySelectorAll('.kpi-num')[0].innerText = proyectos.length;
  document.querySelectorAll('.kpi-num')[1].innerText = '$' + (totalInversion / 1e6).toLocaleString('es-CO', {maximumFractionDigits:0}) + 'M';

  // Pintar Marcadores
  proyectos.forEach(p => {
    const color = getColor(p.secretaria);
    const icon = L.divIcon({ html: `<div style="width:14px;height:14px;border-radius:50%; background:${color};border:2.5px solid white; box-shadow:0 2px 6px rgba(0,0,0,0.5);"></div>`, className:'', iconSize:[14,14], iconAnchor:[7,7] });
    let estClean = p.estado.toLowerCase();
    const badgeClass = estClean.includes('ejecuc') ? 'badge-ejecucion' : estClean.includes('terminad') ? 'badge-terminado' : 'badge-alistamiento';
    const presStr = p.presupuesto > 0 ? `$${Math.round(p.presupuesto/1e6).toLocaleString('es-CO')}M` : '<span style="color:#E74C3C;">No reportado</span>';

    const marker = L.marker([p.lat, p.lon], {icon}).bindPopup(`
      <div style="min-width:240px;">
        <div class="popup-title">${p.nombre}</div>
        <div class="popup-row"><span class="popup-label">Secretar√≠a</span><span class="popup-val" style="color:${color};">${p.secretaria}</span></div>
        <div class="popup-row"><span class="popup-label">Tipo</span><span class="popup-val">${p.tipo}</span></div>
        <div class="popup-row"><span class="popup-label">Direcci√≥n</span><span class="popup-val" style="white-space:normal; max-width:140px;">${p.direccion}</span></div>
        <div class="popup-row"><span class="popup-label">Presupuesto</span><span class="popup-val">${presStr}</span></div>
        <span class="popup-badge ${badgeClass}">${p.estado}</span>
      </div>
    `, {maxWidth:320});
    marker._secGroup = p.secretaria;
    marker._estado = estClean.includes('ejecuc') ? 'En ejecuci√≥n' : estClean.includes('terminad') ? 'Terminado' : 'En alistamiento';
    allMarkers.push(marker);
  });
  applyFilters();
}

async function initDynamicMap() {
  const [ptsRes, polyRes, tramosRes] = await Promise.all([ fetch('../Total_secretarias.geojson'), fetch('../poligonos.geojson'), fetch('../tramos_oriente.geojson') ]);
  globalPtsData = await ptsRes.json();
  const polyData = await polyRes.json();
  const tramosData = await tramosRes.json();

  globalPerimetro = polyData.features.find(f => f.properties.Name === 'Perimetro Proyecto') || polyData.features[0];
  const perimeterLayer = L.geoJSON(globalPerimetro, { style: { color: '#E91E8C', weight: 4, fill: false } }).addTo(map);
  map.fitBounds(perimeterLayer.getBounds(), {padding:[20,20]});

  const areasLayer = L.layerGroup().addTo(map);
  const polyColors = ['#F1C40F', '#E67E22', '#4CAF77', '#9B59B6'];
  let cIdx = 0;
  polyData.features.forEach(f => {
    if (f.properties.Name !== 'Perimetro Proyecto') {
      L.geoJSON(f, { style: { color: polyColors[cIdx % polyColors.length], weight: 2, fillOpacity: 0.3 } }).bindTooltip(`<b>Pol√≠gono de Obra:</b><br>${f.properties.Name}`).addTo(areasLayer);
      cIdx++;
    }
  });

  const tramosLayer = L.geoJSON(tramosData, { style: { color: '#00BCD4', weight: 4, opacity: 0.9 } }).bindTooltip('<b>Corredor H√≠drico</b>').addTo(map);
  
  map.addLayer(clusters);
  L.control.layers(baseMaps, { "üìç Puntos de Obra": clusters, "üü£ L√≠mite del Pulm√≥n": perimeterLayer, "üíß Corredor H√≠drico": tramosLayer, "üü© √Åreas de Proyecto": areasLayer }, { position: 'topright' }).addTo(map);

  renderMapData(); // Pinta el mapa por primera vez (En modo UPS)
}

// Listeners de los filtros y Toggles
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    const b = e.target;
    if (b.dataset.modo) { // Botones de Modo (UPS vs Contratos)
      document.querySelectorAll('#filter-modo .filter-btn').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      currentMode = b.dataset.modo;
      // Actualiza la etiqueta del KPI (Frentes vs Contratos)
      document.querySelectorAll('.kpi-lab')[0].innerText = currentMode === 'ups' ? 'Frentes de Obra' : 'Contratos Totales';
      renderMapData();
    } else if (b.dataset.filter) {
      document.querySelectorAll('#filter-sec .filter-btn').forEach(x => x.classList.remove('active'));
      b.classList.add('active'); activeFilter = b.dataset.filter; applyFilters();
    } else if (b.dataset.estado) {
      document.querySelectorAll('#filter-estado .filter-btn').forEach(x => x.classList.remove('active'));
      b.classList.add('active'); activeEstado = b.dataset.estado; applyFilters();
    }
  });
});
document.getElementById('btn-reset').addEventListener('click', () => {
  activeFilter = 'all'; activeEstado = 'all';
  document.querySelectorAll('.filter-btn[data-filter], .filter-btn[data-estado]').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.filter-btn[data-filter="all"], .filter-btn[data-estado="all"]').forEach(b => b.classList.add('active'));
  applyFilters();
});

initDynamicMap();
</script>

</script>
</body>
</html>